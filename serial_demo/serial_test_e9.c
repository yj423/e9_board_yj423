/* * Demo for Seiral on E9 board(imx6q evaluation board). * * This demo is adapted from a copy on the website. * I try to make this demo simple enough to use and understood. * Also, make this programme Linux-like style. *  * Copyright 2015 Jone Yim yj4231@hotmail.com * * This program is free software; you can redistribute it and/or modify * it under the terms of the GNU General Public License version 2 as * published by the Free Software Foundation. */# include <stdio.h># include <stdlib.h># include <termio.h># include <unistd.h># include <fcntl.h># include <getopt.h># include <time.h># include <errno.h># include <string.h>#define TEST_SPEED(Speed) \	if (baudrate == Speed) \		return B##Speed	static void error(const char *Msg){    fprintf (stderr, "%s/n", Msg);    fprintf (stderr, "strerror() is %s\n", strerror(errno));    exit(1);}static void warning(const char *Msg){     fprintf (stderr, "warning: %s\n", Msg);}static int serial_baudrate(const char *baudrate_str){    int baudrate = atoi(baudrate_str);    TEST_SPEED(1200);    TEST_SPEED(2400);    TEST_SPEED(4800);    TEST_SPEED(9600);    TEST_SPEED(19200);    TEST_SPEED(38400);    TEST_SPEED(57600);    TEST_SPEED(115200);    TEST_SPEED(230400);    error("Bad speed");    return -1;}static void print_usage(void){   fprintf(stderr, "serial_test_e9 - interactive program of serial port\n");   fprintf(stderr, "press crtl+c to quit/n/n");   fprintf(stderr, "Usage: serial_test_e9 [-d device] [-s speed] [-7] [-x] [-o] [-h]\n");   fprintf(stderr, "         -7 7 bit\n");   fprintf(stderr, "         -x hex mode\n");   fprintf(stderr, "         -o output to stdout too\n");   fprintf(stderr, "         -h print this help\n");   exit(-1);}static inline int fd_writeable_block(int fd){    fd_set wset;    FD_ZERO(&wset);    FD_SET(fd, &wset);    if (select(fd + 1, NULL, &wset, NULL, NULL) < 0) {   		error(strerror(errno));    }    return 1;}int main(int argc, char **argv){    int dev_fd;    const char *dev_name = "/dev/ttySAC3";    struct termios tty_attr;    int baudrate = B115200;    int byte_bits = CS8;    int output_hex = 0;    int output_to_stdout = 0;    fd_set rset;	unsigned char data = 0;	int len;	char buf[10];    for (;;) {        int c = getopt(argc, argv, "d:s:t:7xoch");        if (c == -1)            break;        switch(c) {        case 'd':            dev_name = optarg;            break;        case 's':			baudrate = serial_baudrate(optarg);            break;		case 'o':			output_to_stdout = 1;			break;		case '7':			byte_bits = CS7;			break;		case 'x':			output_hex = 1;			break;		case '?':		case 'h':		default:			print_usage();		}	}		if (optind != argc)		print_usage();				dev_fd = open(dev_name, O_RDWR, 0);	if (dev_fd < 0)		error("Unable to open device");			if (fcntl(dev_fd, F_SETFL, O_NONBLOCK) < 0)		error("Unable set to NONBLOCK mode");			memset(&tty_attr, 0, sizeof(struct termios));	tty_attr.c_iflag = IGNPAR;	tty_attr.c_cflag = baudrate | HUPCL | byte_bits | CREAD | CLOCAL;	tty_attr.c_cc[VMIN] = 1;	if (tcsetattr(dev_fd, TCSANOW, &tty_attr) < 0)		warning("Unable to set serial port");		/* Read one byte frome the serial device, and send back through it. */	while(1){		FD_ZERO(&rset);		FD_SET(dev_fd, &rset);				if (select(dev_fd + 1, &rset, NULL, NULL, NULL) < 0) {			 error(strerror(errno));		}				if (FD_ISSET(dev_fd, &rset)) {			while (read(dev_fd, &data, 1) == 1) {			 	/* Block until it can be written */				if(fd_writeable_block(dev_fd) && write(dev_fd, &data, 1) < 0) {					error(strerror(errno));				}				if (output_to_stdout) { 					len = sprintf(buf, output_hex ? "%.2X  " : "%c", data);	 				fwrite(buf, 1, len, stdout);					fflush(stdout);				}			 }		}	}		return 0;}